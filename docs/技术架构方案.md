# 技术架构方案

## 1. 总体架构
```
Browser (Next.js App Router)
 ├─ Voice Panel (WebRTC + XFYun WS)
 ├─ Itinerary Studio (React server components)
 ├─ Finance Console (Recharts)
 └─ Map Canvas (AMap JS SDK)
        ↓
Next.js API Routes / Server Actions
 ├─ /api/itineraries → Supabase (Postgres)
 ├─ /api/ai/plan → DeepSeek / 百炼
 ├─ /api/voice → XFYun token proxy
 ├─ /api/maps → AMap Web Service proxy
 └─ Edge Functions (Supabase) → Budget recalculation, webhooks
```

## 2. 前端技术栈
- **框架**：Next.js 15 (App Router) + React 19 + TypeScript 5。
- **状态管理**：React Server Actions + Zustand（客户端瞬时状态）+ TanStack Query（数据缓存）。
- **样式**：Tailwind CSS + 自建 UI 基础组件（Button、Card、Tabs、Panel、Timeline）；Radix UI 仅承担无样式交互基件。
- **可视化**：Recharts（预算雷达、折线、饼图），Mapbox-like overlay 由自定义 Canvas 实现。
- **语音动效**：Canvas + requestAnimationFrame 渲染声波。

## 3. 后端与数据层
- **API 层**：基于 Next.js Route Handlers，部署于 Vercel / Docker；对外仅暴露 `/api/*`。
- **数据库**：Supabase PostgreSQL，采用以下核心表：
  - `profiles(id, email, display_name, avatar, home_timezone)`
  - `itineraries(id, user_id, title, destination, start_date, end_date, budget, currency, preferences, status)`
  - `itinerary_days(id, itinerary_id, date, summary, ai_version)`
  - `activities(id, day_id, type, title, description, lat, lng, start_time, end_time, cost_min, cost_max, transportation)`
  - `expenses(id, itinerary_id, category, amount, currency, method, voice_trace_id)`
  - `voice_traces(id, user_id, transcript, intent, raw_audio_url)`
- **授权**：Supabase Auth + RLS：
  ```sql
  create policy "Users can access own itineraries" on itineraries
    for all using (auth.uid() = user_id);
  ```
- **Edge Functions**：
  - `budget-snapshot`: 费用变化时重算预算并写入 `budget_snapshots`。
  - `llm-self-heal`: 当 AI 返回格式错误时自动重试。

## 4. 外部服务适配
| 服务 | 用途 | 适配方式 |
| --- | --- | --- |
| DeepSeek / 百炼 | 行程生成、费用估算 | 采用统一 `LLMProvider` 接口，可在 `.env` 中切换 |
| 讯飞实时语音 | 语音转文本 | Next.js API 生成临时 token，前端使用 WebSocket 直连 |
| 高德地图 | 地图渲染 + 地理编码 | 前端加载 JS SDK；服务端代理 Web Service，缓存地理编码结果 |
| Supabase Storage | 语音原始文件、行程导出 | 通过签名 URL 上传/下载 |

## 5. 配置与环境变量
- `NEXT_PUBLIC_SUPABASE_URL` / `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`（仅在 Edge Function 中使用）
- `LLM_PROVIDER`（deepseek / bailian）
- `DEEPSEEK_API_KEY` / `BAILIAN_API_KEY`
- `NEXT_PUBLIC_XFYUN_APP_ID`、`XFYUN_API_KEY`、`XFYUN_API_SECRET`
- `NEXT_PUBLIC_AMAP_KEY`、`AMAP_WEB_SERVICE_KEY`
- `NEXT_PUBLIC_MAP_STYLE`（AuroraVoyage 自定义主题）

## 6. 构建与部署
- **本地开发**：`pnpm dev` + Supabase CLI（可选）。
- **容器化**：Node 20-alpine 基础镜像 → 多阶段构建（依赖安装、构建、运行）。
- **CI/CD**：GitHub Actions
  - Lint & Test
  - Build Docker image → 推送至阿里云 ACR
  - 生成 PDF（通过 `md-to-pdf`）并附加到 Release
- **运行拓扑**：Nginx 反向代理（可选），Next.js Standalone server，连接 Supabase 托管实例。

## 7. 安全与隐私
- 所有 API Key 仅存储在运行环境变量，不写入代码仓库。
- 语音文件默认 30 天自动清理，Supabase Storage Lifecycle 规则实现。
- 针对语音与行程文本，启用敏感内容过滤（Prompt 前置系统指令 + 规则校验）。

## 8. 未来扩展
- 引入多模态（图片/视频）行程灵感模块。
- 支持离线 PWA 模式。
- 行程共享链接 + 协同编辑。
