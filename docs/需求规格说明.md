# 需求规格说明

## 1. 用户角色
- **旅行发起者（Primary Planner）**：负责输入需求、生成/调整行程、记录预算，通常为家庭/团队的决策者。
- **同行者（Collaborator）**：查看共享行程，提交偏好/记账请求，未来版本可写权限。
- **游客模式用户（Guest）**：无需登录即可体验 Demo（仅本地存储）。

## 2. 用户场景
1. 语音说出“5 天日本亲子游，预算 2 万，想吃寿司和逛博物馆”，快速得到可编辑行程。
2. 在地铁上用语音记一笔“大阪环球影城门票 1500 元，餐饮类”。
3. 在桌面端对比不同行程版本，并拖动时间线调整交通顺序。
4. 在手机上查看实时同步的预算提示与地图导航。

## 3. 功能性需求
### 3.1 行程规划
- F1：支持语音/文字输入旅行偏好，字段含目的地、日期/天数、预算、人数、偏好标签。
- F2：调用 LLM 生成“每日安排 + 费用估算 + 交通/住宿/餐饮推荐”，并写入 Supabase。
- F3：提供“生成草稿 → 用户确认 → 保存版本”的流程，保留版本快照。

### 3.2 费用预算与记账
- F4：预算进度实时计算，预算占比显示在雷达图与进度条内。
- F5：语音记账：语音转文本 → 语义解析 → 分类、金额、币种、关联行程日。
- F6：允许用户编辑、删除记账条目，自动同步至 Supabase 并触发预算重算。

### 3.3 用户与数据
- F7：注册登录（邮箱/魔法链接），Supabase Auth 实现；行程数据按 user_id + itinerary_id 隔离。
- F8：每个行程可邀请协作者（通过邮箱），未来版本扩展写权限。
- F9：所有 API 使用 RLS 策略确保数据隔离，导出/导入接口提供 JSON 备份。

### 3.4 地图与导航
- F10：高德地图展示每日景点/餐厅 POI，允许点击查看详情与交通方式。
- F11：地图与时间线联动：悬停/点击时间线节点时，地图高亮对应 POI。
- F12：提供“路线预览”模式，按天连线并展示交通耗时。

### 3.5 语音体验
- F13：支持普通话实时语音转文本，长按按钮启动，松开发送；桌面端支持快捷键（空格）。
- F14：语音输入失败时提供可视化提示并允许改为文字输入。

### 3.6 系统与配置
- F15：所有第三方 Key 由用户在“设置”中输入并保存在浏览器安全存储；服务端仅保留必要密钥。
- F16：提供 Docker 一键部署脚本与 `.env.example`。

## 4. 非功能需求
| 类别 | 指标 |
| --- | --- |
| 性能 | 首屏加载 ≤ 3s；地图交互 60fps；LLM 生成结果分块流式返回 |
| 可用性 | 关键路径操作（创建行程、记账）≤ 3 步；支持 Dark/Light 切换（后续） |
| 安全性 | 所有 API Key 不入库；Supabase RLS；数据传输 HTTPS |
| 可维护性 | TypeScript 100%；采用 eslint + prettier + Husky；UI 组件复用率 ≥ 70% |
| 可移植性 | Docker 镜像基于 Node 20-alpine；提供多环境配置说明 |

## 5. 数据需求
- 实体：User、Itinerary、ItineraryDay、Activity、Budget, Expense, Preference, VoiceTrace。
- 关键字段：
  - `ItineraryDay`: id, itinerary_id, date, theme, summary, ai_response_ref
  - `Activity`: id, day_id, type (sight/food/hotel/traffic), start_time, end_time, location(lat,lng), cost_estimate
  - `Expense`: id, itinerary_id, category, amount, currency, method, voice_trace_id
- 需支持多币种（默认 CNY，允许记录 JPY/USD 等）。

## 6. 外部接口
- DeepSeek/百炼：`POST /v1/chat/completions`，使用函数调用或 structured output。
- 讯飞实时语音：WebSocket 双向流。
- 高德地图：JS SDK + Web 服务（地理编码、路径规划）。
- Supabase：Auth、Restful、Edge Functions。

## 7. 验收标准
- 用户可用语音完成一次完整行程创建与记账；结果保存在云端且地图、预算联动正确。
- 所有关键文档（README、部署指南、API Key 配置、PDF 汇总）完整。
- Git 提交信息清晰，至少包含「需求 → 架构 → 功能 → 测试 → 部署」阶段记录。
